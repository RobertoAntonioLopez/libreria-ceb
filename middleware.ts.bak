import { NextRequest, NextResponse } from "next/server";

/**
 * Rutas públicas (no requieren login).
 */
const PUBLIC_PATHS = new Set([
  "/login",
  "/api/auth/login",
  "/api/auth/logout",

  // Assets típicos
  "/favicon.ico",
  "/icon.png",
  "/ceb-logo.png",
]);

/**
 * Endpoints que deben pasar sin cookie porque se protegen por token propio
 * (ej: ?token=... o Authorization: Bearer ...).
 */
const TOKEN_ENDPOINTS = new Set([
  "/api/export/books",
  "/api/export/books-csv",
  "/api/export/loans",
  "/api/backup",
  "/api/test-db",
]);

function isPublicAsset(pathname: string) {
  // Next internal + archivos estáticos comunes
  if (pathname.startsWith("/_next/")) return true;
  if (pathname.startsWith("/assets/")) return true;
  if (pathname.startsWith("/fonts/")) return true;
  if (pathname.endsWith(".png")) return true;
  if (pathname.endsWith(".jpg") || pathname.endsWith(".jpeg")) return true;
  if (pathname.endsWith(".webp")) return true;
  if (pathname.endsWith(".svg")) return true;
  if (pathname.endsWith(".css")) return true;
  if (pathname.endsWith(".js")) return true;
  if (pathname.endsWith(".ico")) return true;
  return false;
}

function hasSessionCookie(req: NextRequest) {
  // Ajusta aquí si tu cookie tiene otro nombre
  const c1 = req.cookies.get("auth")?.value;
  const c2 = req.cookies.get("auth_token")?.value;
  const c3 = req.cookies.get("token")?.value;

  return Boolean(c1 || c2 || c3);
}

export default function proxy(req: NextRequest) {
  const { pathname } = req.nextUrl;

  // 1) Permitir assets / internos
  if (isPublicAsset(pathname)) return NextResponse.next();

  // 2) Permitir rutas públicas
  if (PUBLIC_PATHS.has(pathname)) return NextResponse.next();

  // 3) Permitir endpoints que se protegen por token (backup/export)
  if (TOKEN_ENDPOINTS.has(pathname)) return NextResponse.next();

  // 4) Proteger todo lo demás
  const loggedIn = hasSessionCookie(req);

  if (loggedIn) return NextResponse.next();

  // 5) Si es API, NO redirigir (devuelve 401 JSON)
  if (pathname.startsWith("/api/")) {
    return NextResponse.json(
      { ok: false, error: "Unauthorized" },
      { status: 401 }
    );
  }

  // 6) Si es página, redirigir a /login y conservar destino
  const url = req.nextUrl.clone();
  url.pathname = "/login";
  url.searchParams.set("next", pathname);

  return NextResponse.redirect(url);
}

export const config = {
  matcher: ["/:path*"],
};
